#!/bin/bash

(
  set -e -x

  trap clean_vagrant EXIT

  clean_vagrant() {
    vagrant destroy remote -f || true
  }

  echo -e "\n Get stemcell version... "
  build_num=$(cat stemcell-version/number | cut -f1 -d.)

  echo -e "\n Navigate to vagrant directory..."
  cd bosh-src/bosh-stemcell

  echo -e "\n Copy s3cfg to vagrant shared directory..."
  cp ../../bosh-softlayer-private/.s3cfg .

  echo -e "\n Bring up vagrant stemcell building VM for AWS EC2-Classic..."
  vagrant up remote --provider=aws

  echo -e "\n Build stemcell, then upload to S3 bucket..."
  vagrant ssh -c "
    cd /bosh
    bundle
    export CANDIDATE_BUILD_NUMBER=$build_num
    export STEMCELL_BUILD_NUMBER=$build_num
    bundle exec rake stemcell:build[softlayer,hyperv,ubuntu,trusty,go,bosh-os-images,bosh-ubuntu-trusty-os-image.tgz]
  " remote

  mkdir ../../out

  vagrant scp remote:/mnt/stemcells/$IAAS/$HYPERVISOR/$OS_NAME/work/work/*.tgz ../../out/
)




